<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>    CentOS 6.4 software raid & LVM
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
            <link rel="stylesheet" href="./theme/css/normalize.css">
        <link href='//fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="./theme/css/font-awesome.min.css">
        <link rel="stylesheet" href="./theme/css/main.css">

    <link rel="stylesheet" href="./theme/css/blog.css">
    <link rel="stylesheet" href="./theme/css/github.css">
        <link href="https://visibilityspots.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Visibilityspots Atom Feed" />
        <link href="https://visibilityspots.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Visibilityspots RSS Feed" />
        <script src="./theme/js/vendor/modernizr-2.6.2.min.js"></script>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <div id="wrapper">
<header id="sidebar" class="side-shadow">
    <hgroup id="site-header">
        <a id="site-title" href="."><h1>Visibilityspots.com <i class="icon-dashboard"></i></h1></a>
        <p id="site-desc"> Linux & Open-Source enthousiast | Scouting | Longboarding </p>
    </hgroup>
    <nav>
        <ul id="nav-links">
                <li><a href="./pages/contact.html">Contact</a></li>
                <li><a href="./pages/links.html">Links</a></li>
                <li><a href="./pages/profile.html">Profile</a></li>
                <li><a href="./pages/projects.html">Projects</a></li>
        </ul>
    </nav>
    Categories:
      <ul>
          <li><a href="http://www.visibilityspots.com/category/android.html">android</a></li>
          <li><a href="http://www.visibilityspots.com/category/apple.html">apple</a></li>
          <li><a href="http://www.visibilityspots.com/category/home-automation.html">home-automation</a></li>
          <li><a href="http://www.visibilityspots.com/category/linux.html">linux</a></li>
          <li><a href="http://www.visibilityspots.com/category/networking.html">networking</a></li>
          <li><a href="http://www.visibilityspots.com/category/php.html">php</a></li>
          <li><a href="http://www.visibilityspots.com/category/puppet.html">puppet</a></li>
          <li><a href="http://www.visibilityspots.com/category/security.html">security</a></li>
      </ul>
<script charset="utf-8" src="http://widgets.twimg.com/j/2/widget.js"></script>
<script>
new TWTR.Widget({
  version: 2,
  type: 'profile',
  rpp: 3,
  interval: 30000,
  width: 'auto',
  height: 300,
  theme: {
	shell: {
	  background: '#eeeeee',
	  color: '#000000'
	},
	tweets: {
	  background: '#eeeeee',
	  color: '#000000',
	  links: '#1a50a1'
	}
  },
  features: {
	scrollbar: false,
	loop: false,
	live: false,
	behavior: 'all'
  }
}).render().setUser('visibilityspots').start();
</script>
<footer id="site-info">
    <a href="http://creativecommons.org/licenses/by-nc/2.0/be/deed.nl">License</a> | 2009 - 2013 <a href="http://www.visibilityspots.com">Visibilityspots.com</a> | Powered by <a href="http://getpelican.com/" target="pelican">Pelican</a> | <a href="http://visibilityspots.com/feeds/all.atom.xml" rel="alternate">Atom</a> feed
</footer></header>    <div id="post-container">
        <ol id="post-list">
            <li>
                <article class="post-entry">
                    <header class="entry-header">
                        <time class="post-time" datetime="2013-07-24T23:00:00" pubdate>
				Wed 24 July 2013
                        </time>
                        <a href="./raid.html" rel="bookmark"><h1>CentOS 6.4 software raid &amp; LVM</h1></a>
                        <time class="post-time" datetime="2013-07-24T23:00:00" pubdate>
                        </time>
                    </header>

                    <section class="post-content">
			<p>Been asked to setup a software raid of 12TB on a minimal CentOS 6.4 installation with 5 disks of 3TB each. Never played with raid nor lvm before so the challenge was great!</p>
<p>I started by doing research about <a class="reference external" href="http://www.cyberciti.biz/tips/raid5-vs-raid-10-safety-performance.html">RAID</a>. Came to the conclusion that RAID 5 was the best option for our purpose. So kept looking for a way to implement a software raid and stumbled into <a class="reference external" href="http://linux.die.net/man/8/mdadm">mdadm</a>.</p>
<p>Using the information of <a class="reference external" href="http://richard.blog.kraya.co.uk/2012/04/27/3tb-hdd-raid5-centos-6-2/">Richard</a>'s and <a class="reference external" href="http://zackreed.me/articles/48-adding-an-extra-disk-to-an-mdadm-array">Zack Reed</a>'s blogs I easily setted up the raid array and created some lvm volumes on top of that.</p>
<p>Creating of 3TB partitions on the physical disks</p>
<pre class="literal-block">
# parted /dev/sdX
# (parted) mklabel gpt
# (parted) unit TB
# (parted) mkpart primary 0.00TB 3.00TB
# (parted) print
</pre>
<p>Creating the raid5 array with all the prepared disks</p>
<pre class="literal-block">
# mdadm --create /dev/md0 --level=raid5 --raid-devices=5 /dev/sdX# /dev/sdX# /dev/sdX# /dev/sdX# /dev/sd#
</pre>
<p>Viewing the state of creation of the new array</p>
<pre class="literal-block">
# watch cat /proc/mdstat
</pre>
<p>Once the array is successfully created you have to store it into the config file</p>
<pre class="literal-block">
# echo &quot;DEVICE partitions&quot; &gt; /etc/mdadm.conf
# echo &quot;MAILADDR root&#64;localhost&quot; &gt;&gt; /etc/mdadm.conf
# mdadm --detail --scan &gt;&gt; /etc/mdadm.conf
</pre>
<p>so we can start creating lvm volumes on top of them</p>
<pre class="literal-block">
# pvcreate /dev/md0
# vgcreate vg_NAME /dev/md0
# lvcreate --name lv_NAME -l 100%FREE vg_NAME
</pre>
<p>We now created a physical volume, a volume group and a logical volume which can easily be resized and moved on top of the raid5 setup</p>
<p>To start using the volume we finally have to create a file system on it and check if everything went alright</p>
<pre class="literal-block">
# mkfs.ext4 /dev/vg_NAME/lv_NAME
# fsck.ext4 -f /dev/vg_NAME/lv_NAME
</pre>
<p>After the succesfull file system chack I came to a working raid setup. Nevertheless I figured out that by rebooting the machine the raid array wasn't initializing as I expected. Instead of the md0 as configured the raid array was coming up as a read-only one named md127. I did some research and found a usefull topic on it on the redhat <a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=606481">bugzilla</a> forum.</p>
<p>There I found out that this can be reactivated manually by stopping the read-only instance and reassambling the array based on the /etc/mdadm.conf file:</p>
<pre class="literal-block">
# mdadm --stop /dev/md172
# mdadm --assemble --scan
</pre>
<p>Although that's not really the best solution because you have to do this by every reboot of your system. So I looked a bit further and found out you can regenerate your initramfs image using your mdadm.conf file using dracut:</p>
<pre class="literal-block">
# mv /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.old
# dracut --mdadmconf --force /boot/initramfs-$(uname -r).img $(uname -r)
</pre>
<p>Once that images is build I successfully rebooted the system and the md0 came up without any problem.</p>
<p>The final step is to get the new logical volume  mounted automatically at boot, therefore you have to add something in your /etc/fstab file:</p>
<pre class="literal-block">
# /dev/mapper/vg_NAME-lv_NAME /var/NAME ext4 defaults 1 1
</pre>
<p>Some useful commands</p>
<pre class="literal-block">
## Stop raid array
# mdadm --stop /dev/md0

## Start raid array
# mdadm --assemble --scan
</pre>
<p>Resources:</p>
<ul class="simple">
<li>tcpdump: <a class="reference external" href="http://www.tcpdump.com/kb/os/linux/removing-raid-devices.html">removing</a></li>
<li>tcpdump: <a class="reference external" href="http://www.tcpdump.com/kb/os/linux/starting-and-stopping-raid-arrays.html">restarting</a></li>
<li><a class="reference external" href="http://www.ducea.com/2009/03/08/mdadm-cheat-sheet/">cheat</a> sheet</li>
<li>raid <a class="reference external" href="https://wiki.xkyle.com/Mdadm#Pause_a_Verify_or_Rebuild">states</a></li>
<li><a class="reference external" href="http://www.howtoforge.com/how-to-create-a-raid1-setup-on-an-existing-centos-redhat-6.0-system">howtoforge</a> initramfs</li>
</ul>

                    </section>
                    <hr/>
                    <aside class="post-meta">
                        <p>Category: <a href="./category/linux.html">linux</a></p>
                        <p>Tags: <a href="./tag/software.html">software</a>, <a href="./tag/raid.html">raid</a>, <a href="./tag/softwareraid.html">softwareraid</a>, <a href="./tag/lvm.html">lvm</a>, <a href="./tag/mdadm.html">mdadm</a>, <a href="./tag/centos.html">centos</a>, </p>
                    </aside>
                    <hr/>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'visibilityspots';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
                </article>
            </li>
        </ol>
    </div>
        </div>

        <script src="./theme/js/main.js"></script>
    </body>
</html>